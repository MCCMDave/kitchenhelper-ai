<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://api.kitchenhelper-ai.de http://127.0.0.1:8000 http://192.168.2.54:8000 http://100.103.86.47:8000; frame-ancestors 'none'; base-uri 'self'; form-action 'self';">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <title>KitchenHelper-AI - Login</title>
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div class="auth-page">
        <div class="auth-box">
            <!-- Header Actions Container -->
            <div style="position: absolute; top: var(--spacing-md); right: var(--spacing-md); display: flex; gap: 8px; align-items: center;">
                <!-- Theme Dropdown -->
                <div class="theme-menu">
                <button class="theme-toggle" onclick="ThemeMenu.toggle(event)" aria-label="Farbschema wÃ¤hlen" title="Farbschema">
                    <span class="theme-icon">ğŸŒ™</span>
                </button>

                <div class="theme-dropdown" id="theme-dropdown">
                    <div class="theme-dropdown-grid">
                        <!-- Light Modes -->
                        <button class="theme-dot-btn" data-theme="light" onclick="ThemeMenu.setTheme('light')" title="Hell">
                            <span style="font-size: 14px; margin-right: 4px;">ğŸŒ</span>
                            <div class="theme-dot-double">
                                <div class="theme-dot" style="background: #4CAF50"></div>
                                <div class="theme-dot" style="background: #2196F3"></div>
                            </div>
                        </button>
                        <button class="theme-dot-btn" data-theme="sepia" onclick="ThemeMenu.setTheme('sepia')" title="Sepia">
                            <span style="font-size: 14px; margin-right: 4px;">ğŸ“œ</span>
                            <div class="theme-dot-double">
                                <div class="theme-dot" style="background: #8B7355"></div>
                                <div class="theme-dot" style="background: #7B8B8E"></div>
                            </div>
                        </button>
                        <button class="theme-dot-btn" data-theme="ocean-light" onclick="ThemeMenu.setTheme('ocean-light')" title="Ozean Hell">
                            <span style="font-size: 14px; margin-right: 4px;">ğŸŒŠ</span>
                            <div class="theme-dot-double">
                                <div class="theme-dot" style="background: #0891B2"></div>
                                <div class="theme-dot" style="background: #3B82F6"></div>
                            </div>
                        </button>
                        <button class="theme-dot-btn" data-theme="forest-light" onclick="ThemeMenu.setTheme('forest-light')" title="Wald Hell">
                            <span style="font-size: 14px; margin-right: 4px;">ğŸŒ²</span>
                            <div class="theme-dot-double">
                                <div class="theme-dot" style="background: #059669"></div>
                                <div class="theme-dot" style="background: #16A34A"></div>
                            </div>
                        </button>
                        <button class="theme-dot-btn" data-theme="sunset-light" onclick="ThemeMenu.setTheme('sunset-light')" title="Sonnenuntergang Hell">
                            <span style="font-size: 14px; margin-right: 4px;">ğŸŒ…</span>
                            <div class="theme-dot-double">
                                <div class="theme-dot" style="background: #F97316"></div>
                                <div class="theme-dot" style="background: #EC4899"></div>
                            </div>
                        </button>

                        <!-- Dark Modes -->
                        <button class="theme-dot-btn" data-theme="dark" onclick="ThemeMenu.setTheme('dark')" title="Dunkel">
                            <span style="font-size: 14px; margin-right: 4px;">ğŸŒ™</span>
                            <div class="theme-dot-double">
                                <div class="theme-dot" style="background: #66BB6A"></div>
                                <div class="theme-dot" style="background: #42A5F5"></div>
                            </div>
                        </button>
                        <button class="theme-dot-btn" data-theme="nord" onclick="ThemeMenu.setTheme('nord')" title="Nord">
                            <span style="font-size: 14px; margin-right: 4px;">â„ï¸</span>
                            <div class="theme-dot-double">
                                <div class="theme-dot" style="background: #88C0D0"></div>
                                <div class="theme-dot" style="background: #81A1C1"></div>
                            </div>
                        </button>
                        <button class="theme-dot-btn" data-theme="solarized" onclick="ThemeMenu.setTheme('solarized')" title="Solarized">
                            <span style="font-size: 14px; margin-right: 4px;">ğŸŒƒ</span>
                            <div class="theme-dot-double">
                                <div class="theme-dot" style="background: #268BD2"></div>
                                <div class="theme-dot" style="background: #2AA198"></div>
                            </div>
                        </button>
                        <button class="theme-dot-btn" data-theme="dracula" onclick="ThemeMenu.setTheme('dracula')" title="Dracula">
                            <span style="font-size: 14px; margin-right: 4px;">ğŸ§›</span>
                            <div class="theme-dot-double">
                                <div class="theme-dot" style="background: #BD93F9"></div>
                                <div class="theme-dot" style="background: #8BE9FD"></div>
                            </div>
                        </button>
                        <button class="theme-dot-btn" data-theme="ocean-dark" onclick="ThemeMenu.setTheme('ocean-dark')" title="Ozean Dunkel">
                            <span style="font-size: 14px; margin-right: 4px;">ğŸŒŠ</span>
                            <div class="theme-dot-double">
                                <div class="theme-dot" style="background: #06B6D4"></div>
                                <div class="theme-dot" style="background: #60A5FA"></div>
                            </div>
                        </button>
                        <button class="theme-dot-btn" data-theme="forest-dark" onclick="ThemeMenu.setTheme('forest-dark')" title="Wald Dunkel">
                            <span style="font-size: 14px; margin-right: 4px;">ğŸŒ²</span>
                            <div class="theme-dot-double">
                                <div class="theme-dot" style="background: #10B981"></div>
                                <div class="theme-dot" style="background: #22C55E"></div>
                            </div>
                        </button>
                        <button class="theme-dot-btn" data-theme="sunset-dark" onclick="ThemeMenu.setTheme('sunset-dark')" title="Sonnenuntergang Dunkel">
                            <span style="font-size: 14px; margin-right: 4px;">ğŸŒ†</span>
                            <div class="theme-dot-double">
                                <div class="theme-dot" style="background: #FB923C"></div>
                                <div class="theme-dot" style="background: #F472B6"></div>
                            </div>
                        </button>
                    </div>
                </div>
                </div>

                <!-- Language Dropdown -->
                <div class="lang-menu">
                    <button class="lang-toggle" onclick="i18n.toggleDropdown(event)" title="Sprache / Language">
                        <span class="lang-icon">ğŸŒ</span>
                        <span class="lang-toggle-text">DE</span>
                    </button>

                    <div class="lang-dropdown" id="lang-dropdown">
                        <button class="lang-option" onclick="i18n.setLanguage('de')">ğŸ‡©ğŸ‡ª Deutsch</button>
                        <button class="lang-option" onclick="i18n.setLanguage('en')">ğŸ‡¬ğŸ‡§ English</button>
                        <button class="lang-option" onclick="i18n.setLanguage('fr')">ğŸ‡«ğŸ‡· FranÃ§ais</button>
                        <button class="lang-option" onclick="i18n.setLanguage('es')">ğŸ‡ªğŸ‡¸ EspaÃ±ol</button>
                        <button class="lang-option" onclick="i18n.setLanguage('it')">ğŸ‡®ğŸ‡¹ Italiano</button>
                        <button class="lang-option" onclick="i18n.setLanguage('pt')">ğŸ‡µğŸ‡¹ PortuguÃªs</button>
                    </div>
                </div>
            </div>

            <div class="auth-header">
                <h1 class="auth-title">KitchenHelper-AI</h1>
                <p class="auth-subtitle" data-i18n="auth.subtitle">Dein KI-Rezeptgenerator</p>
            </div>

            <!-- Auth Tabs -->
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login" data-i18n="auth.login">Anmelden</button>
                <button class="auth-tab" data-tab="register" data-i18n="auth.register">Registrieren <span style="font-size: 0.85em; opacity: 0.8;">(kostenlos)</span></button>
            </div>

            <!-- Error Display -->
            <div id="auth-error" class="auth-error" style="display: none;"></div>

            <!-- Login Form -->
            <form id="login-form" class="auth-form active">
                <div class="form-group">
                    <label class="form-label" data-i18n="auth.email_or_username">E-Mail oder Benutzername</label>
                    <input type="text" id="login-email" class="form-control" data-i18n-placeholder="auth.email_or_username" placeholder="E-Mail oder Benutzername" required>
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="auth.password">Passwort</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="login-password" class="form-control" data-i18n-placeholder="auth.password" placeholder="Passwort" required>
                        <button type="button" class="password-toggle" onclick="togglePassword(this)" title="Passwort anzeigen">
                            <span class="toggle-icon">ğŸ‘ï¸</span>
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-block btn-lg" id="login-btn" data-i18n="auth.login">
                    Anmelden
                </button>
                <a href="reset-password.html" class="forgot-password-link" data-i18n="auth.forgot_password">
                    Passwort vergessen?
                </a>
            </form>

            <!-- Register Form -->
            <form id="register-form" class="auth-form">
                <div class="form-group">
                    <label class="form-label" data-i18n="auth.email">E-Mail-Adresse</label>
                    <input type="email" id="register-email" class="form-control" placeholder="deine@email.de" required>
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="auth.username">Benutzername</label>
                    <input type="text" id="register-username" class="form-control" placeholder="meinusername" required minlength="3" maxlength="20" pattern="[a-zA-Z0-9_-]+">
                    <small class="form-hint" data-i18n="auth.username_hint">3-20 Zeichen, nur Buchstaben, Zahlen, - und _</small>
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="auth.password">Passwort</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="register-password" class="form-control" data-i18n-placeholder="auth.password_min" placeholder="Mind. 6 Zeichen" required minlength="6">
                        <button type="button" class="password-toggle" onclick="togglePassword(this)" title="Passwort anzeigen">
                            <span class="toggle-icon">ğŸ‘ï¸</span>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="auth.password_confirm">Passwort bestÃ¤tigen</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="register-password-confirm" class="form-control" data-i18n-placeholder="auth.password_repeat" placeholder="Passwort wiederholen" required>
                        <button type="button" class="password-toggle" onclick="togglePassword(this)" title="Passwort anzeigen">
                            <span class="toggle-icon">ğŸ‘ï¸</span>
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-block btn-lg" id="register-btn" data-i18n="auth.register">
                    Registrieren
                </button>
            </form>

        </div>
    </div>

    <!-- Password Reset Modal -->
    <div id="password-reset-modal" class="modal-overlay">
        <div class="modal password-reset-modal">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="reset.title">Passwort zurÃ¼cksetzen</h3>
                <button class="modal-close" onclick="closeResetModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Request Reset -->
                <div id="reset-step-1">
                    <p style="margin-bottom: var(--spacing-md); color: var(--text-muted);" data-i18n="reset.step1_text">
                        Gib deine E-Mail-Adresse ein, um einen Reset-Code zu erhalten.
                    </p>
                    <div class="form-group">
                        <label class="form-label" data-i18n="auth.email">E-Mail</label>
                        <input type="email" id="reset-email" class="form-control" placeholder="deine@email.de" required>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="requestPasswordReset()" data-i18n="reset.request_code">
                        Reset-Code anfordern
                    </button>
                </div>

                <!-- Step 2: Enter Token + New Password -->
                <div id="reset-step-2" style="display: none;">
                    <p style="margin-bottom: var(--spacing-md); color: var(--text-muted);" data-i18n="reset.step2_text">
                        Gib den Reset-Code und dein neues Passwort ein.
                    </p>
                    <div class="form-group">
                        <label class="form-label" data-i18n="reset.code">Reset-Code</label>
                        <input type="text" id="reset-token" class="form-control" data-i18n-placeholder="reset.code_placeholder" placeholder="Code aus der Console/Email">
                    </div>
                    <div class="form-group">
                        <label class="form-label" data-i18n="reset.new_password">Neues Passwort</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="reset-new-password" class="form-control" data-i18n-placeholder="auth.password_min" placeholder="Mind. 6 Zeichen" minlength="6">
                            <button type="button" class="password-toggle" onclick="togglePassword(this)">
                                <span class="toggle-icon">ğŸ‘ï¸</span>
                            </button>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="resetPassword()" data-i18n="reset.change_password">
                        Passwort Ã¤ndern
                    </button>
                    <button class="btn btn-ghost btn-block" onclick="showResetStep1()" style="margin-top: var(--spacing-sm);" data-i18n="reset.back">
                        ZurÃ¼ck
                    </button>
                </div>

                <!-- Success Message -->
                <div id="reset-step-success" style="display: none;">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <div style="font-size: 48px; margin-bottom: var(--spacing-md);">âœ…</div>
                        <p style="color: var(--success); font-weight: var(--font-semibold);" data-i18n="reset.success">
                            Passwort erfolgreich geÃ¤ndert!
                        </p>
                        <p style="color: var(--text-muted); margin-top: var(--spacing-sm);" data-i18n="reset.success_hint">
                            Du kannst dich jetzt mit deinem neuen Passwort anmelden.
                        </p>
                        <button class="btn btn-primary" onclick="closeResetModal()" style="margin-top: var(--spacing-lg);" data-i18n="reset.to_login">
                            Zum Login
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script>
        // ==================== THEME MENU ====================
        const ThemeMenu = {
            init() {
                // Load saved theme
                const savedTheme = localStorage.getItem('colorTheme') || 'light';
                this.setTheme(savedTheme, false);

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.theme-menu')) {
                        this.close();
                    }
                });

                // Update active theme dot
                this.updateActiveDot(savedTheme);
            },

            toggle(event) {
                event.stopPropagation();
                const dropdown = document.getElementById('theme-dropdown');
                dropdown.classList.toggle('show');
            },

            close() {
                const dropdown = document.getElementById('theme-dropdown');
                dropdown.classList.remove('show');
            },

            setTheme(theme, showMessage = true) {
                // Set theme on document
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('colorTheme', theme);

                // Update theme icon based on theme
                const icon = document.querySelector('.theme-icon');
                if (icon) {
                    const themeIcons = {
                        'light': 'ğŸŒ',
                        'sepia': 'ğŸ“œ',
                        'ocean-light': 'ğŸŒŠ',
                        'forest-light': 'ğŸŒ²',
                        'sunset-light': 'ğŸŒ…',
                        'dark': 'ğŸŒ™',
                        'nord': 'â„ï¸',
                        'solarized': 'ğŸŒƒ',
                        'dracula': 'ğŸ§›',
                        'ocean-dark': 'ğŸŒŠ',
                        'forest-dark': 'ğŸŒ²',
                        'sunset-dark': 'ğŸŒ†'
                    };
                    icon.textContent = themeIcons[theme] || 'ğŸŒ™';
                }

                // Update active dot
                this.updateActiveDot(theme);

                // Don't close dropdown - keep it open
                // this.close();

                // Success message
                if (showMessage && typeof UI !== 'undefined') {
                    const themeName = i18n.translate(`settings.theme_${theme}`);
                    const msg = i18n.currentLang === 'de'
                        ? `Farbschema "${themeName}" aktiviert!`
                        : `Color scheme "${themeName}" activated!`;
                    UI.success(msg);
                }

                console.log('[ThemeMenu] Set to:', theme);
            },

            updateActiveDot(theme) {
                // Remove active state from all dots
                document.querySelectorAll('.theme-dot-btn').forEach(btn => {
                    btn.removeAttribute('data-theme-active');
                });

                // Add active state to current theme
                const activeBtn = document.querySelector(`.theme-dot-btn[data-theme="${theme}"]`);
                if (activeBtn) {
                    activeBtn.setAttribute('data-theme-active', 'true');
                }
            }
        };

        // Redirect if already logged in
        if (Auth.redirectIfAuthenticated()) {
            // Will redirect to dashboard
        }

        // Initialize i18n and theme
        document.addEventListener('DOMContentLoaded', () => {
            i18n.init();
            i18n.updateUI();
            ThemeMenu.init();

            // Update lang toggle text
            const langText = document.querySelector('.lang-toggle-text');
            if (langText) {
                langText.textContent = i18n.currentLang.toUpperCase();
            }
        });

        // Password toggle function
        function togglePassword(button) {
            const wrapper = button.closest('.password-input-wrapper');
            const input = wrapper.querySelector('input');
            const icon = button.querySelector('.toggle-icon');

            if (input.type === 'password') {
                input.type = 'text';
                icon.textContent = 'ğŸ™ˆ';
                button.classList.add('visible');
            } else {
                input.type = 'password';
                icon.textContent = 'ğŸ‘ï¸';
                button.classList.remove('visible');
            }
        }

        // Tab switching
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Update tabs
                document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Update forms
                document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
                document.getElementById(`${tab.dataset.tab}-form`).classList.add('active');

                // Clear error
                hideError();
            });
        });

        // Show error
        let errorTimeout = null;
        function showError(message) {
            const errorEl = document.getElementById('auth-error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';

            // Clear existing timeout
            if (errorTimeout) {
                clearTimeout(errorTimeout);
            }

            // Hide error after 5 seconds
            errorTimeout = setTimeout(() => {
                hideError();
            }, 5000);
        }

        // Hide error
        function hideError() {
            document.getElementById('auth-error').style.display = 'none';
        }

        // Set button loading
        function setLoading(btn, loading) {
            btn.disabled = loading;
            if (loading) {
                btn.dataset.originalText = btn.textContent;
                btn.textContent = i18n.t('common.loading');
            } else {
                btn.textContent = btn.dataset.originalText || btn.textContent;
            }
        }

        // Login form
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError();

            const emailOrUsername = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');

            if (!emailOrUsername) {
                showError(i18n.t('error.invalid_email'));
                return;
            }

            setLoading(btn, true);

            try {
                await Auth.login(emailOrUsername, password);
                window.location.href = 'dashboard.html';
            } catch (error) {
                console.error('[Login] Error:', error);
                let message = i18n.t('error.login_failed');
                let clearEmail = false;

                if (error.message.includes('fetch')) {
                    message = i18n.t('error.fetch_failed');
                } else if (error.message) {
                    message = error.message;
                }

                // Detect if email/username is wrong (401/404) vs wrong password (401)
                // If status is 404 or message contains "not found", clear email field
                if (error.status === 404 || message.toLowerCase().includes('not found') ||
                    message.toLowerCase().includes('user not found') ||
                    message.toLowerCase().includes('invalid email')) {
                    clearEmail = true;
                }

                showError(message);

                // Clear password field always
                document.getElementById('login-password').value = '';

                // Clear email only if user not found
                if (clearEmail) {
                    document.getElementById('login-email').value = '';
                }

                setLoading(btn, false);
            }
        });

        // Register form
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError();

            const email = document.getElementById('register-email').value.trim();
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;
            const btn = document.getElementById('register-btn');

            // Validate email - stricter but allow a@a.a
            const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{1,}$/;
            if (!email || !emailRegex.test(email)) {
                showError(i18n.t('error.invalid_email'));
                return;
            }

            // Validate username
            if (!username || username.length < 3) {
                showError(i18n.t('error.username_too_short'));
                return;
            }

            if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
                showError(i18n.t('error.username_invalid'));
                return;
            }

            // Validate passwords match
            if (password !== passwordConfirm) {
                showError(i18n.t('error.passwords_not_match'));
                return;
            }

            // Validate password length
            if (password.length < 6) {
                showError(i18n.t('error.password_too_short'));
                return;
            }

            setLoading(btn, true);

            try {
                console.log('[Register] Attempting registration:', { email, username });
                await Auth.register(email, username, password);
                window.location.href = 'dashboard.html';
            } catch (error) {
                console.error('[Register] Error:', error);
                let message = i18n.t('error.registration_failed');

                if (error.message.includes('fetch')) {
                    message = i18n.t('error.fetch_failed');
                } else if (error.message.includes('E-Mail') || error.message.includes('email')) {
                    message = i18n.t('error.email_taken');
                } else if (error.message.includes('Benutzername') || error.message.includes('username')) {
                    message = i18n.t('error.username_taken');
                } else if (error.message) {
                    message = error.message;
                }

                showError(message);
                setLoading(btn, false);
            }
        });

        // ==================== PASSWORD RESET ====================
        document.getElementById('forgot-password-link').addEventListener('click', (e) => {
            e.preventDefault();
            openResetModal();
        });

        function openResetModal() {
            const modal = document.getElementById('password-reset-modal');
            modal.classList.add('show');
            showResetStep1();
        }

        function closeResetModal() {
            const modal = document.getElementById('password-reset-modal');
            modal.classList.remove('show');
            document.getElementById('reset-email').value = '';
            document.getElementById('reset-token').value = '';
            document.getElementById('reset-new-password').value = '';
            showResetStep1();
            hideError();
        }

        function showResetStep1() {
            document.getElementById('reset-step-1').style.display = 'block';
            document.getElementById('reset-step-2').style.display = 'none';
            document.getElementById('reset-step-success').style.display = 'none';
        }

        function showResetStep2() {
            document.getElementById('reset-step-1').style.display = 'none';
            document.getElementById('reset-step-2').style.display = 'block';
            document.getElementById('reset-step-success').style.display = 'none';
        }

        function showResetSuccess() {
            document.getElementById('reset-step-1').style.display = 'none';
            document.getElementById('reset-step-2').style.display = 'none';
            document.getElementById('reset-step-success').style.display = 'block';
        }

        async function requestPasswordReset() {
            const email = document.getElementById('reset-email').value;

            if (!email || !email.includes('@')) {
                showError(i18n.t('error.invalid_email'));
                return;
            }

            hideError();

            try {
                const response = await api.post('/auth/request-password-reset', { email });
                console.log('[PasswordReset] Response:', response);

                if (response.dev_token) {
                    alert('DEV MODE: Reset-Token: ' + response.dev_token + '\n\nKopiere diesen Token in das nÃ¤chste Feld.');
                }

                showResetStep2();
            } catch (error) {
                const lang = i18n.currentLang;
                showError(error.message || (lang === 'de' ? 'Fehler beim Anfordern des Reset-Codes.' : 'Error requesting reset code.'));
            }
        }

        async function resetPassword() {
            const token = document.getElementById('reset-token').value;
            const newPassword = document.getElementById('reset-new-password').value;

            if (!token) {
                showError(i18n.t('error.reset_code_required'));
                return;
            }

            if (!newPassword || newPassword.length < 6) {
                showError(i18n.t('error.password_too_short'));
                return;
            }

            hideError();

            try {
                await api.post('/auth/reset-password', { token, new_password: newPassword });
                showResetSuccess();
            } catch (error) {
                const lang = i18n.currentLang;
                showError(error.message || (lang === 'de' ? 'Fehler beim ZurÃ¼cksetzen des Passworts.' : 'Error resetting password.'));
            }
        }

        // Close modal on overlay click
        document.getElementById('password-reset-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeResetModal();
            }
        });

        // Close on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeResetModal();
            }
        });
    </script>

    <!-- Footer mit Impressum-Link -->
    <footer style="position: fixed; bottom: 0; width: 100%; text-align: center; padding: 10px; background: var(--bg); border-top: 1px solid var(--border); font-size: 12px; color: var(--text-secondary);">
        <a href="impressum.html" style="color: var(--primary); text-decoration: none; margin: 0 10px;">Impressum</a>
        <span style="margin: 0 5px;">Â·</span>
        <span>Â© 2025 Melucio-Labs</span>
    </footer>
</body>
</html>
