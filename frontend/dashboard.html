<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KitchenHelper-AI - Dashboard</title>
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">ğŸ³ KitchenHelper-AI</div>
                    <div class="header-actions">
                        <div id="active-profiles" class="active-profiles-badge">
                            <!-- Wird dynamisch befÃ¼llt -->
                        </div>
                        <!-- Language Toggle -->
                        <button class="lang-toggle header-lang-toggle" onclick="i18n.toggle()" title="Sprache / Language">
                            <span class="lang-icon">ğŸŒ</span>
                            <span class="lang-toggle-text">DE</span>
                        </button>

                        <button id="theme-toggle" class="theme-toggle" aria-label="Theme umschalten" title="Dark/Light Mode">
                            <span class="theme-icon">ğŸŒ™</span>
                        </button>

                        <!-- User Menu mit Emoji + Dropdown -->
                        <div class="user-menu">
                            <button class="user-avatar" onclick="UserMenu.toggle(event)">
                                <span class="user-emoji" id="user-emoji">ğŸ‘¤</span>
                                <span class="user-tier-badge" id="user-tier">Demo</span>
                            </button>

                            <div class="user-dropdown" id="user-dropdown">
                                <div class="dropdown-header">
                                    <strong id="dropdown-name">User</strong>
                                    <span id="dropdown-email">email@test.de</span>
                                </div>
                                <hr>
                                <button onclick="UserMenu.goToProModel()" data-i18n="nav.pro_model">ğŸ’ Pro Model</button>
                                <button onclick="UserMenu.goToProfiles()" data-i18n="nav.profiles">ğŸ‘¤ PrÃ¤ferenzen</button>
                                <button onclick="UserMenu.goToSettings()" data-i18n="nav.settings">âš™ï¸ Settings</button>
                                <hr>
                                <button onclick="Auth.logout()" data-i18n="auth.logout">ğŸšª Logout</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <!-- Navigation Tabs (Profile/Settings accessible via dropdown menu) -->
                <nav class="tabs nav-tabs">
                    <button class="tab active" data-section="ingredients" data-i18n="nav.ingredients">Ingredients</button>
                    <button class="tab" data-section="recipes" data-i18n="nav.recipes">Recipes</button>
                    <button class="tab" data-section="favorites" data-i18n="nav.favorites">Favorites</button>
                </nav>

                <!-- Sections -->
                <!-- Ingredients Section -->
                <section id="ingredients-section" class="section active">
                    <div class="page-header">
                        <h1 class="page-title" data-i18n="ingredients.title">ğŸ¥— My Ingredients</h1>
                        <div class="page-header-actions">
                            <button class="btn btn-outline" onclick="Ingredients.showSpiceQuickSelect()">âš¡ <span data-i18n="ingredients.spices">GewÃ¼rze</span></button>
                            <button class="btn btn-primary" onclick="Ingredients.showAddModal()" data-i18n="ingredients.add">+ Add Ingredient</button>
                        </div>
                    </div>
                    <div class="filters" style="margin-bottom: var(--spacing-lg);">
                        <select id="ingredient-category-filter" class="form-control" style="max-width: 200px;" onchange="Ingredients.load()">
                            <option value="" data-i18n="ingredients.all_categories">All Categories</option>
                        </select>
                    </div>
                    <div id="ingredients-list" class="grid grid-3"></div>
                </section>

                <!-- Recipes Section -->
                <section id="recipes-section" class="section">
                    <div class="page-header">
                        <h1 class="page-title" data-i18n="recipes.title">ğŸ½ï¸ Generate Recipes</h1>
                    </div>

                    <!-- Ingredient Selection -->
                    <div class="ingredient-selection card">
                        <h3 class="ingredient-selection-title" data-i18n="recipes.select_ingredients">Select your ingredients</h3>
                        <div id="ingredient-checkboxes" class="ingredient-checkboxes"></div>
                        <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-md); flex-wrap: wrap; align-items: center;">
                            <button class="btn btn-primary btn-lg" onclick="Recipes.generate()" id="generate-btn">
                                ğŸ¤– <span data-i18n="recipes.generate">Generate Recipes</span>
                            </button>
                            <span id="selected-count" style="color: var(--text-muted);">0 <span data-i18n="recipes.selected">ingredients selected</span></span>
                        </div>
                    </div>

                    <!-- Generated Recipes -->
                    <h2 style="margin: var(--spacing-xl) 0 var(--spacing-lg);" data-i18n="recipes.generated">Generated Recipes</h2>
                    <div id="recipes-list" class="grid grid-2"></div>

                    <!-- Recipe History -->
                    <h2 style="margin: var(--spacing-xl) 0 var(--spacing-lg);" data-i18n="recipes.history">Recent Recipes</h2>
                    <div id="recipe-history" class="grid grid-2"></div>
                </section>

                <!-- Favorites Section -->
                <section id="favorites-section" class="section">
                    <div class="page-header">
                        <h1 class="page-title" data-i18n="favorites.title">â­ My Favorites</h1>
                    </div>
                    <div class="search-bar" style="margin-bottom: var(--spacing-lg);">
                        <input type="text" id="favorites-search" class="form-control" placeholder="Search favorites..." data-i18n-placeholder="favorites.search_placeholder" oninput="Favorites.search(this.value)">
                    </div>
                    <div id="favorites-list" class="grid grid-2"></div>
                </section>

                <!-- Profiles Section (accessible via dropdown menu) -->
                <section id="profiles-section" class="section">
                    <div class="page-header">
                        <h1 class="page-title" data-i18n="profiles.title">ğŸ‘¤ Diet Profiles</h1>
                    </div>
                    <div id="profiles-list"></div>
                </section>

                <!-- Settings Section (accessible via dropdown menu) -->
                <section id="settings-section" class="section">
                    <div class="page-header">
                        <h1 class="page-title" data-i18n="settings.title">âš™ï¸ Settings</h1>
                    </div>

                    <div class="settings-section">
                        <h2 class="settings-title" data-i18n="settings.profile">Edit Profile</h2>
                        <form id="settings-form">
                            <div class="form-group">
                                <label class="form-label" data-i18n="settings.avatar_emoji">Avatar Emoji</label>
                                <div class="emoji-picker-container">
                                    <input type="text" id="settings-emoji" class="form-control emoji-input" placeholder="ğŸ‘¤" maxlength="2">
                                    <div class="emoji-suggestions">
                                        <button type="button" class="emoji-btn" onclick="Settings.setEmoji('ğŸ‘¤')">ğŸ‘¤</button>
                                        <button type="button" class="emoji-btn" onclick="Settings.setEmoji('ğŸ‘¨')">ğŸ‘¨</button>
                                        <button type="button" class="emoji-btn" onclick="Settings.setEmoji('ğŸ‘©')">ğŸ‘©</button>
                                        <button type="button" class="emoji-btn" onclick="Settings.setEmoji('ğŸ§‘')">ğŸ§‘</button>
                                        <button type="button" class="emoji-btn" onclick="Settings.setEmoji('ğŸ‘¨â€ğŸ³')">ğŸ‘¨â€ğŸ³</button>
                                        <button type="button" class="emoji-btn" onclick="Settings.setEmoji('ğŸ‘©â€ğŸ³')">ğŸ‘©â€ğŸ³</button>
                                        <button type="button" class="emoji-btn" onclick="Settings.setEmoji('ğŸ³')">ğŸ³</button>
                                        <button type="button" class="emoji-btn" onclick="Settings.setEmoji('ğŸ¥—')">ğŸ¥—</button>
                                        <button type="button" class="emoji-btn" onclick="Settings.setEmoji('ğŸ•')">ğŸ•</button>
                                        <button type="button" class="emoji-btn" onclick="Settings.setEmoji('ğŸ˜Š')">ğŸ˜Š</button>
                                        <button type="button" class="emoji-btn" onclick="Settings.setEmoji('ğŸŒŸ')">ğŸŒŸ</button>
                                        <button type="button" class="emoji-btn" onclick="Settings.setEmoji('ğŸ”¥')">ğŸ”¥</button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-i18n="auth.username">Username</label>
                                <input type="text" id="settings-username" class="form-control" placeholder="myusername" minlength="3" maxlength="20">
                                <small class="form-hint" data-i18n="auth.username_hint">3-20 characters, letters, numbers, - and _ only</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-i18n="auth.email">Email</label>
                                <input type="email" id="settings-email" class="form-control" placeholder="your@email.com">
                            </div>
                            <button type="submit" class="btn btn-primary" data-i18n="common.save">Save</button>
                        </form>
                    </div>

                    <div class="settings-section">
                        <h2 class="settings-title" data-i18n="settings.change_password">Change Password</h2>
                        <form id="password-form">
                            <div class="form-group">
                                <label class="form-label" data-i18n="settings.new_password">New Password</label>
                                <div class="password-input-wrapper">
                                    <input type="password" id="settings-password" class="form-control" placeholder="Min. 6 characters" minlength="6">
                                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility('settings-password', this)">ğŸ‘ï¸</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-i18n="settings.confirm_password">Confirm Password</label>
                                <div class="password-input-wrapper">
                                    <input type="password" id="settings-password-confirm" class="form-control" placeholder="Repeat password">
                                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility('settings-password-confirm', this)">ğŸ‘ï¸</button>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary" data-i18n="settings.change_password">Change Password</button>
                        </form>
                    </div>

                    <div class="settings-section">
                        <h2 class="settings-title" data-i18n="settings.account_info">Account Info</h2>
                        <div id="account-info"></div>
                    </div>

                    <div class="settings-section" style="border-left: 4px solid var(--danger);">
                        <h2 class="settings-title" style="color: var(--danger);" data-i18n="settings.danger_zone">âš ï¸ Danger Zone</h2>
                        <p style="margin-bottom: var(--spacing-md); color: var(--text-muted);" data-i18n="settings.danger_warning">
                            Warning: This action cannot be undone!
                        </p>
                        <button class="btn btn-danger" onclick="Settings.deleteAccount()" data-i18n="settings.delete_account">Delete Account</button>
                    </div>
                </section>

                <!-- Pro Model Section -->
                <section id="pro-model-section" class="section">
                    <div class="page-header">
                        <h1 class="page-title">ğŸ’ <span data-i18n="pro.title">Pro Model Features</span></h1>
                    </div>

                    <div class="card" style="max-width: 800px; margin: 0 auto;">
                        <h2 data-i18n="pro.what_is_pro">Was ist KitchenHelper-AI Pro?</h2>
                        <p style="margin-bottom: var(--spacing-lg); color: var(--text-muted);" data-i18n="pro.description">
                            Upgrade to Pro and unlock advanced AI features with better recipe quality and more personalization.
                        </p>

                        <div style="display: grid; gap: var(--spacing-md);">
                            <!-- Free Tier -->
                            <div style="padding: var(--spacing-md); border: 2px solid var(--border); border-radius: var(--border-radius);">
                                <h3>ğŸ†“ <span data-i18n="pro.free_tier">Free Tier</span></h3>
                                <ul style="list-style: none; padding: 0; margin-top: var(--spacing-md);">
                                    <li>âœ… <span data-i18n="pro.free_basic_recipes">Basic recipe generation</span></li>
                                    <li>âœ… <span data-i18n="pro.free_ingredients">Ingredient management</span></li>
                                    <li>âœ… <span data-i18n="pro.free_profiles">Up to 3 dietary profiles</span></li>
                                    <li>âœ… <span data-i18n="pro.free_favorites">Favorite recipes</span></li>
                                    <li>âš ï¸ <span data-i18n="pro.free_model">Uses: llama3.2:3b (smaller model)</span></li>
                                    <li>âš ï¸ <span data-i18n="pro.free_limit">Limited daily requests</span></li>
                                </ul>
                            </div>

                            <!-- Pro Tier -->
                            <div style="padding: var(--spacing-md); border: 3px solid var(--primary); border-radius: var(--border-radius); background: linear-gradient(135deg, rgba(87, 103, 255, 0.1), rgba(87, 103, 255, 0.05));">
                                <h3>ğŸ’ <span data-i18n="pro.pro_tier">Pro Tier</span></h3>
                                <ul style="list-style: none; padding: 0; margin-top: var(--spacing-md);">
                                    <li>âœ¨ <span data-i18n="pro.pro_advanced">Advanced recipe generation</span></li>
                                    <li>âœ¨ <span data-i18n="pro.pro_model">Uses: llama3.3:70b (premium model)</span></li>
                                    <li>âœ¨ <span data-i18n="pro.pro_quality">Better recipe quality & creativity</span></li>
                                    <li>âœ¨ <span data-i18n="pro.pro_unlimited">Unlimited daily requests</span></li>
                                    <li>âœ¨ <span data-i18n="pro.pro_profiles">Unlimited dietary profiles</span></li>
                                    <li>âœ¨ <span data-i18n="pro.pro_priority">Priority support</span></li>
                                    <li>âœ¨ <span data-i18n="pro.pro_encryption">End-to-end data encryption</span></li>
                                </ul>

                                <div style="margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--border);">
                                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: var(--spacing-md);">
                                        <div>
                                            <div style="font-size: 2em; font-weight: 700; color: var(--primary);">â‚¬4.99<span style="font-size: 0.5em; font-weight: 400;">/Monat</span></div>
                                            <div style="color: var(--text-muted); font-size: 0.9em;" data-i18n="pro.cancel_anytime">Jederzeit kÃ¼ndbar</div>
                                        </div>
                                        <button class="btn btn-primary btn-lg" onclick="ProModel.subscribe()" id="pro-subscribe-btn">
                                            ğŸ’ <span data-i18n="pro.upgrade_now">Jetzt upgraden</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Current Status -->
                            <div id="pro-status" style="padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--border-radius); text-align: center;">
                                <div style="font-size: 0.9em; color: var(--text-muted);">
                                    <span data-i18n="pro.current_tier">Aktueller Plan:</span>
                                    <strong id="current-tier-display" style="color: var(--primary);">Free</strong>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--border);">
                            <h3 data-i18n="pro.faq">HÃ¤ufige Fragen</h3>
                            <details style="margin-top: var(--spacing-md);">
                                <summary style="cursor: pointer; font-weight: 600;" data-i18n="pro.faq_payment">Welche Zahlungsmethoden werden akzeptiert?</summary>
                                <p style="margin-top: var(--spacing-sm); color: var(--text-muted);" data-i18n="pro.faq_payment_answer">
                                    Wir akzeptieren Kreditkarten, PayPal und SEPA-Lastschrift.
                                </p>
                            </details>
                            <details style="margin-top: var(--spacing-sm);">
                                <summary style="cursor: pointer; font-weight: 600;" data-i18n="pro.faq_cancel">Kann ich jederzeit kÃ¼ndigen?</summary>
                                <p style="margin-top: var(--spacing-sm); color: var(--text-muted);" data-i18n="pro.faq_cancel_answer">
                                    Ja, du kannst dein Abo jederzeit in den Einstellungen kÃ¼ndigen. Es lÃ¤uft bis zum Ende des bezahlten Zeitraums.
                                </p>
                            </details>
                            <details style="margin-top: var(--spacing-sm);">
                                <summary style="cursor: pointer; font-weight: 600;" data-i18n="pro.faq_difference">Was ist der Unterschied zwischen den Modellen?</summary>
                                <p style="margin-top: var(--spacing-sm); color: var(--text-muted);" data-i18n="pro.faq_difference_answer">
                                    Das Pro-Modell (llama3.3:70b) ist deutlich grÃ¶ÃŸer und intelligenter. Es erstellt kreativere Rezepte, berÃ¼cksichtigt PrÃ¤ferenzen besser und liefert detailliertere Anweisungen.
                                </p>
                            </details>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/ingredients.js"></script>
    <script src="js/recipes.js"></script>
    <script src="js/favorites.js"></script>
    <script src="js/profiles.js"></script>
    <script src="js/pro-model.js"></script>
    <script src="js/user-menu.js"></script>
    <script>
        // ==================== THEME SWITCHER ====================
        const Theme = {
            init() {
                // Load saved theme
                const savedTheme = localStorage.getItem('kitchenhelper_theme') || 'light';
                this.setTheme(savedTheme);

                // Setup toggle button
                const toggle = document.getElementById('theme-toggle');
                if (toggle) {
                    toggle.addEventListener('click', () => this.toggle());
                }
            },

            setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('kitchenhelper_theme', theme);

                // Update icon
                const icon = document.querySelector('.theme-icon');
                if (icon) {
                    icon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
                }

                console.log('[Theme] Set to:', theme);
            },

            toggle() {
                const current = document.documentElement.getAttribute('data-theme');
                const newTheme = current === 'dark' ? 'light' : 'dark';
                this.setTheme(newTheme);
            }
        };

        // Require authentication
        if (!Auth.requireAuth()) {
            // Will redirect to login
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            Theme.init();
            initDashboard();
        });

        async function initDashboard() {
            // Load user info
            const user = Auth.getCurrentUser();
            if (user) {
                // Update User Menu
                UserMenu.updateUserInfo(user);
            }

            // Setup navigation
            setupNavigation();

            // Load initial data
            await Ingredients.load();

            // Load profiles for active badge
            await Profiles.load();

            // Setup settings form
            setupSettingsForm();
        }

        function setupNavigation() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // Update tabs
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Update sections
                    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                    document.getElementById(`${tab.dataset.section}-section`).classList.add('active');

                    // Load section data
                    loadSectionData(tab.dataset.section);
                });
            });
        }

        async function loadSectionData(section) {
            switch (section) {
                case 'ingredients':
                    await Ingredients.load();
                    break;
                case 'recipes':
                    await Recipes.loadIngredientSelection();
                    await Recipes.loadHistory();
                    break;
                case 'favorites':
                    await Favorites.load();
                    break;
                case 'profiles':
                    await Profiles.load();
                    break;
                case 'settings':
                    loadSettingsData();
                    break;
            }
        }

        function setupSettingsForm() {
            // Profile form
            document.getElementById('settings-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('settings-username').value.trim();
                const email = document.getElementById('settings-email').value.trim();
                const emoji = document.getElementById('settings-emoji').value;

                // Validate username
                if (username && (username.length < 3 || !/^[a-zA-Z0-9_-]+$/.test(username))) {
                    UI.error(i18n.t('error.username_invalid'));
                    return;
                }

                try {
                    const data = {};
                    if (username) data.username = username;
                    if (email) data.email = email;
                    if (emoji) data.emoji = emoji;

                    if (Object.keys(data).length > 0) {
                        await Auth.updateProfile(data);
                        UI.success(i18n.currentLang === 'de' ? 'Profil aktualisiert!' : 'Profile updated!');

                        // Update User Menu
                        const user = Auth.getCurrentUser();
                        UserMenu.updateUserInfo(user);
                    }
                } catch (error) {
                    UI.error(error.message);
                }
            });

            // Password form
            document.getElementById('password-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const password = document.getElementById('settings-password').value;
                const confirm = document.getElementById('settings-password-confirm').value;

                if (password !== confirm) {
                    UI.error(i18n.t('error.passwords_not_match'));
                    return;
                }

                if (password.length < 6) {
                    UI.error(i18n.t('error.password_too_short'));
                    return;
                }

                try {
                    await Auth.updateProfile({ password });
                    UI.success(i18n.currentLang === 'de' ? 'Passwort geÃ¤ndert!' : 'Password changed!');
                    document.getElementById('password-form').reset();
                } catch (error) {
                    UI.error(error.message);
                }
            });
        }

        function loadSettingsData() {
            const user = Auth.getCurrentUser();
            if (user) {
                document.getElementById('settings-username').value = user.username || '';
                document.getElementById('settings-email').value = user.email || '';
                document.getElementById('settings-emoji').value = user.emoji || 'ğŸ‘¤';

                const tierInfo = Auth.getTierInfo();
                const lang = i18n.currentLang;
                const labels = lang === 'de'
                    ? { username: 'Benutzername', email: 'E-Mail', subscription: 'Abonnement', recipes: 'Rezepte heute', member: 'Mitglied seit' }
                    : { username: 'Username', email: 'Email', subscription: 'Subscription', recipes: 'Recipes today', member: 'Member since' };

                document.getElementById('account-info').innerHTML = `
                    <p><strong>${labels.username}:</strong> ${user.username}</p>
                    <p><strong>${labels.email}:</strong> ${user.email}</p>
                    <p><strong>${labels.subscription}:</strong> ${tierInfo.name}</p>
                    <p><strong>${labels.recipes}:</strong> ${user.daily_recipe_count} / ${user.daily_limit}</p>
                    <p><strong>${labels.member}:</strong> ${UI.formatDate(user.created_at)}</p>
                `;
            }
        }

        // Settings module
        const Settings = {
            setEmoji(emoji) {
                document.getElementById('settings-emoji').value = emoji;
            },

            async saveEmoji() {
                const emoji = document.getElementById('settings-emoji').value || 'ğŸ‘¤';
                try {
                    await Auth.updateProfile({ emoji });
                    UserMenu.updateUserInfo(Auth.getCurrentUser());
                    UI.success(i18n.currentLang === 'de' ? 'Emoji aktualisiert!' : 'Emoji updated!');
                } catch (error) {
                    UI.error(error.message);
                }
            },

            deleteAccount() {
                const msg = i18n.currentLang === 'de'
                    ? 'Bist du sicher? Dein Account und alle Daten werden unwiderruflich gelÃ¶scht!'
                    : 'Are you sure? Your account and all data will be permanently deleted!';
                UI.confirm(msg, async () => {
                    try {
                        await api.deleteMe();
                        Auth.logout();
                    } catch (error) {
                        UI.error(error.message);
                    }
                });
            }
        };
    </script>
</body>
</html>
